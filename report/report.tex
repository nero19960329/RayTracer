\documentclass[11pt,a4paper]{ctexart}

\usepackage{latexsym}
\usepackage{amssymb}
\usepackage{CJK}
\usepackage{graphicx}
\usepackage{geometry}
\usepackage{multirow}
\usepackage{fourier}
\usepackage{array}
\usepackage{url}
\usepackage{caption}
\usepackage{subcaption}
\usepackage{enumitem}

\author{软件32班\quad{}王昭\\学号: 2013013330}
\title{光线追踪渲染器实验报告}
\begin{document}
\begin{CJK*}{GBK}{kai}
\makeatletter
\renewcommand{\section}{\@startsection{section}{1}{0mm}{-\baselineskip}{0.5\baselineskip}{\Large\bf\leftline}}
\makeatother
\maketitle

\section {实验环境}
\begin{itemize}[noitemsep]
\item CPU：Intel i5-6500 @ 3.20GHz * 4
\item Memory：16GB
\item OS：Windows 10 教育版
\item Visual Studio：2013
\end{itemize}

\section {操作说明}
\subsection {程序运行方法}
\par{} 在控制台运行渲染程序，需要输入两个参数：用于渲染的场景文件（".scene"），漫游/只渲染模式（-travel/-render）。其中场景文件的定义将会在之后详细讲述。比如：
\centerline{RayTracer.exe cornell\_box.scene -travel}
即可让渲染器执行对康奈尔盒场景进行渲染，并可以在其中进行漫游的操作。漫游模式只建议在小场景中使用，对于较大或者需要进行超采样的场景，建议使用渲染模式：
\centerline{RayTracer.exe dragon.scene -render}
即可让渲染器执行对dragon.scene场景进行渲染的操作。渲染过程中会在控制台中显示进度条，并在渲染成功后显示渲染时间。

\subsection {漫游方法}
\par{} 在以漫游方式进入程序后，可以通过以下方法来进行漫游：
\begin{description}[align=left, labelwidth=5cm]
\item [W、S、A、D键] 前进、后退、左移、右移一小步；
\item [上、下、左、右箭头键] 向上、向下、向左、向右旋转一点角度；
\item [Q键] 退出程序
\end{description}

\subsection {场景文件的定义}
\par{} 场景文件中存储了照相机以及各个景物的信息。以\#开头的行被视为注释，每块信息的首行为即将定义的目标，随后几行为该目标的属性。建议在定义场景时，属性的顺序严格按照如下的顺序进行书写（带*的属性为非必需属性）。
\begin{description}[noitemsep]
\item[照相机] Viewer
    \begin{description}[noitemsep]
    \item[图像大小] geo int(width) int(height)
    \item[照相机位置] center vec3
    \item[目标位置] target vec3
    \item[照相机北方] up vec3
    \item[视角（上下）] fovy double
    \item[景深*] dop double(光圈大小) double(焦距) int(超采样数)
    \item[抗锯齿*] anti int(超采样数)
    \end{description}
\item[点光源] Light
    \begin{description}[noitemsep]
    \item[位置] origin vec3
    \item[颜色] color string(颜色名)
    \item[光强] intensity double
    \end{description}
\item[无限平面] Plane
    \begin{description}[noitemsep]
    \item[纹理] texture ...
    \item[法向] normal vec3
    \item[偏移量] offset double
    \end{description}
\item[球] Sphere
    \begin{description}[noitemsep]
    \item[纹理] texture ...
    \item[中心] center vec3
    \item[半径] radius double
    \item[内部折射率*] refraction\_index string(折射率种类)
    \end{description}
\item[三角网格面] Face
    \begin{description}[noitemsep]
    \item[纹理] texture ...
    \item[点A] a double
    \item[点B] b double
    \item[点C] c double
    \end{description}
\item[网格模型] Mesh
    \begin{description}[noitemsep]
    \item[纹理] texture ...
    \item[模型文件名] file string
    \item[中心位置] center vec3
    \item[包围球半径] radius real
    \item[光滑着色*] smooth bool(true/false)
    \end{description}
\end{description}
\par{} 接下来对几个需要输入特殊值的属性做详细说明：
\begin{description}[noitemsep]
\item[颜色名] 共有8种颜色：WHITE,BLACK,RED,GREEN,BLUE,YELLOW,CYAN,MAGENTA
\item[材料名] 共有4种材料：FLOOR,MIRROR（全镜面反射）,A\_BIT\_MIRROR（一点镜面反射）,TRANSPARENT\_MATERIAL（全透明）,PLASTIC
\item[折射率种类] 共有3种折射率：VACUUM\_REFRACTION\_INDEX（真空）,WATER\_REFRACTION\_INDEX（水）,GLASS\_REFRACTION\_INDEX （玻璃）
\item[纹理] 均以texture开头，需要注意的是，图片纹理只支持正方形图片作为输入。
    \begin{description}[noitemsep]
    \item[纯色纹理] PureTexture string(材料名) string(颜色名)
    \item[黑白格纹理] GridTexture string(材料名) int(格密度)
    \item[图片纹理] ImageTexture string(材料名) string(纹理图片名) int(纹理大小)*
    \end{description}
\end{description}
\par{} 具体样例可以见scene目录下的所有场景文件。

\section {实现内容}
\par{} 本次实验实现的内容涉及较多，接下来将会一一说明：
\subsection {光线追踪}
\par{} 首先规定好照相机的各个参数，之后对每个像素计算出需要追踪的光线。对于每条追踪光线，求出它与场景内物体的交点并计算出局部光照，随后根据情况递归计算该点的反射及折射光强，直至反射/折射次数达到上限（本次实验中为5）。

\subsection {局部光照明}
\par{} 在本次实验中使用Phong光照模型\footnote{\url{https://en.wikipedia.org/wiki/Phong_reflection_model}}对物体进行着色。对于物体上每个点局部光照的计算公式如下：
\[ I_{p}=k_{a}i_{a}+\sum_{m\in lights} (k_{d}(\hat{L_{m}}\cdot\hat{N})i_{m,d}+k_{s}(\hat{R_{m}}\cdot\hat{V})^{\alpha}i_{m,s}) \]
\par{} 其中$k_{a},k_{d},k_{s},\alpha$为环境光反射系数、漫反射系数、高光系数、反光系数，$\hat{L_{m}},\hat{N},\hat{R_{m}},\hat{V}$分别为交点指向光源、交点处法向、入射光反射方向以及交点指向视点向量的归一化向量。

\subsection {阴影}
\par{} 对于每个光线与物体的交点，需要从该点向所有光源发射阴影测试线，来判断该光源是否能照射到这一点。如果不能，则只计算该点的环境光强。

\subsection {物体的表示及求交}
\begin{description}[align=left,labelwidth=1.5cm]
\item[无限平面] 每个无限平面由一对法向及偏移量唯一构成。在判断交点位置时，首先判断光线是否与平面相交，之后通过计算光线起点在平面法线上的投影来得到结果。
\item[球] 每个球可以通过中心和半径来定义。可以通过上课讲过的几何法来判断光线与球的交点位置。
\item[三角形] 用三个顶点来定义三角形。采用了Moller-Trumbore方法\footnote{\url{http://pkuwwt.github.io/scholarship/2014-04-03-ray-triangle-intersection-tests-for-dummies/}} 来实现求交，该方法在得到交点的同时，也获取了交点同三个顶点的系数关系，为之后法向插值做准备。
\item[包围盒] 这里采用与坐标轴平行的包围盒。采用了Andrew Kensler方法\footnote{\url{http://psgraphics.blogspot.com/2016/02/new-simple-ray-box-test-from-andrew.html}} 进行求交，该方法使用了较少的计算和比较，主要是无需对NaN情况进行特判，减少了一部分的计算量。
\end{description}

\subsection {光强衰减模型}
\par{} 使用Lambert定律\footnote{\url{https://en.wikipedia.org/wiki/BeerCLambert_law}}实现了对光强衰减的模拟计算，公式如下：
\[ I_{t}=I_{0}\cdot e^{-\tau}=I_{0}\cdot e^{-\mu l} \]
其中，$\mu$为衰减系数（实验中取为$0.02$），$l$为光线所走的距离。图\ref{fig:lambert}体现了有无光强衰减模型的区别。
\begin{figure}
    \centering
    \begin{subfigure}{0.4\textwidth}
        \includegraphics[width=\textwidth]{./img/without_lambert.png}
        \caption{没有衰减}
    \end{subfigure}
    ~
    \begin{subfigure}{0.4\textwidth}
        \includegraphics[width=\textwidth]{./img/lambert.png}
        \caption{存在衰减}
    \end{subfigure}
    \label{fig:lambert}
\end{figure}

\subsection {纹理}

\subsection {KD树}

\subsection {光滑着色}

\subsection {抗锯齿}

\subsection {景深}

\subsection {并行加速}

\end{CJK*}
\end{document}
